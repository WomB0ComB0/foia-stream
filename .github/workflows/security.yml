# FOIA Stream CI/CD Security Pipeline
#
# Implements comprehensive security scanning in CI/CD
# Addresses: GAP-003 (Security Scanning in CI/CD Pipeline)
# Controls: SA-11, A.8.25, A.8.31, 3.14.1

name: Security Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # Run security scans daily at 2 AM UTC
    - cron: '0 2 * * *'

env:
  BUN_VERSION: '1.3.2'

jobs:
  # ============================================
  # SAST - Static Application Security Testing
  # ============================================
  sast:
    name: Static Analysis
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      # TypeScript type checking as security measure
      - name: TypeScript check
        run: bun tsc --noEmit

      # ESLint security rules
      - name: ESLint security scan
        run: |
          bun add -d @typescript-eslint/eslint-plugin eslint-plugin-security
          bunx eslint . --ext .ts --format sarif --output-file eslint-results.sarif || true
        continue-on-error: true

      - name: Upload ESLint results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: eslint-results.sarif
        continue-on-error: true

      # Semgrep SAST
      - name: Semgrep SAST scan
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/secrets
            p/typescript
            p/nodejs
        continue-on-error: true

      - name: Upload Semgrep results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: semgrep.sarif
        continue-on-error: true

  # ============================================
  # SCA - Software Composition Analysis
  # ============================================
  dependency-scan:
    name: Dependency Scanning
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      # Snyk vulnerability scan
      - name: Snyk vulnerability scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=medium --sarif-file-output=snyk.sarif

      - name: Upload Snyk results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: snyk.sarif
        continue-on-error: true

      # npm audit equivalent using bun
      - name: Audit dependencies
        run: |
          # Create audit report
          bun pm ls --json > dependencies.json || true

          # Check for known vulnerabilities using npm audit on package.json
          npm audit --json > audit-results.json 2>&1 || true

          # Parse and report critical/high vulnerabilities
          if [ -f audit-results.json ]; then
            echo "## Dependency Audit Results" >> $GITHUB_STEP_SUMMARY
            cat audit-results.json | jq -r '.vulnerabilities // {} | to_entries[] | select(.value.severity == "critical" or .value.severity == "high") | "- **\(.value.severity)**: \(.key) - \(.value.title // "No title")"' >> $GITHUB_STEP_SUMMARY || echo "No critical/high vulnerabilities found" >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true

      # OSV Scanner for additional coverage
      - name: OSV Scanner
        run: |
          # Install and run google/osv-scanner locally (uses Go to install the binary)
          set -e
          if ! command -v osv-scanner >/dev/null 2>&1; then
            echo "Installing osv-scanner..."
            go install github.com/google/osv-scanner/cmd/osv-scanner@latest
            # Add GOPATH bin to PATH for this step
            export PATH="$PATH:$(go env GOPATH 2>/dev/null)/bin"
          fi
          # Run the scanner with same args as before
          osv-scanner --lockfile=bun.lock --format=sarif --output=osv-results.sarif
        continue-on-error: true

      - name: Upload OSV results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: osv-results.sarif
        continue-on-error: true

  # ============================================
  # Secret Detection
  # ============================================
  secret-scan:
    name: Secret Detection
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Gitleaks secret detection
      # Note: No license required for personal GitHub accounts
      - name: Gitleaks scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      # TruffleHog for additional coverage
      - name: TruffleHog scan
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --only-verified
        continue-on-error: true

  # ============================================
  # Container Security (if applicable)
  # ============================================
  container-scan:
    name: Container Security
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'
    permissions:
      contents: read
      security-events: write
      packages: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for Dockerfile
        id: dockerfile
        run: |
          if [ -f Dockerfile ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Build image for scanning
        if: steps.dockerfile.outputs.exists == 'true'
        run: docker build -t foia-stream:scan .

      - name: Trivy vulnerability scan
        if: steps.dockerfile.outputs.exists == 'true'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'foia-stream:scan'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
        continue-on-error: true

      - name: Upload Trivy results
        if: steps.dockerfile.outputs.exists == 'true'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
        continue-on-error: true

  # ============================================
  # License Compliance
  # ============================================
  license-check:
    name: License Compliance
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Check licenses
        run: |
          # Install license checker
          bun add -d license-checker

          # Generate license report
          bunx license-checker --summary --out licenses.txt

          # Check for problematic licenses
          echo "## License Summary" >> $GITHUB_STEP_SUMMARY
          cat licenses.txt >> $GITHUB_STEP_SUMMARY

          # Fail if GPL or AGPL licenses found (adjust as needed)
          if bunx license-checker --failOn 'GPL;AGPL' 2>/dev/null; then
            echo "âœ… No problematic licenses found" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Potentially problematic licenses detected" >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true

  # ============================================
  # Security Tests
  # ============================================
  security-tests:
    name: Security Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run security tests
        run: bun test tests/security --coverage
        env:
          DATABASE_URL: ':memory:'
          JWT_SECRET: 'test-jwt-secret-for-ci-security-tests-only'
          NODE_ENV: test
        continue-on-error: true

      - name: Run all tests
        run: bun test --coverage
        env:
          DATABASE_URL: ':memory:'
          JWT_SECRET: 'test-jwt-secret-for-ci-security-tests-only'
          NODE_ENV: test

  # ============================================
  # DAST - Dynamic Testing (on staging)
  # ============================================
  dast:
    name: Dynamic Security Testing
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: [sast, dependency-scan, security-tests]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Start application
        run: |
          bun run start &
          sleep 10  # Wait for app to start
        env:
          DATABASE_URL: ':memory:'
          JWT_SECRET: 'test-jwt-secret-for-ci-dast-only'
          NODE_ENV: test
          PORT: 3000

      - name: OWASP ZAP Baseline scan
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: 'http://localhost:3000'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'
        continue-on-error: true

  # ============================================
  # Security Report
  # ============================================
  security-report:
    name: Security Report
    runs-on: ubuntu-latest
    needs: [sast, dependency-scan, secret-scan, security-tests]
    if: always()

    steps:
      - name: Generate security summary
        run: |
          echo "# ðŸ”’ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Scan | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| SAST | ${{ needs.sast.result == 'success' && 'âœ… Passed' || 'âš ï¸ Issues Found' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Scan | ${{ needs.dependency-scan.result == 'success' && 'âœ… Passed' || 'âš ï¸ Issues Found' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Detection | ${{ needs.secret-scan.result == 'success' && 'âœ… Passed' || 'âš ï¸ Issues Found' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Tests | ${{ needs.security-tests.result == 'success' && 'âœ… Passed' || 'âš ï¸ Issues Found' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "For detailed findings, check the Security tab in this repository." >> $GITHUB_STEP_SUMMARY

      - name: Fail if critical issues
        if: needs.sast.result == 'failure' || needs.secret-scan.result == 'failure'
        run: |
          echo "Critical security issues found. Please review the security scan results."
          exit 1
